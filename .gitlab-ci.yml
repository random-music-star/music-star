stages:
  - deploy

variables:
  SERVER_IP: j12a202.p.ssafy.io
  SSH_USER: ubuntu
  PROJECT_DIR: ~/S12P21A202/FE
  CONTAINER_NAME: nextjs-app
  IMAGE_NAME: nextjs-app
  PORT: 3000

deploy-frontend:
  stage: deploy
  only:
    - FE
  tags:
    - prod

  before_script:
    - echo "ðŸ“¦ Installing SSH client"
    - apt-get update -y && apt-get install -y openssh-client
    - echo "ðŸ” Setting up SSH key"
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "ðŸ”‘ Adding server to known_hosts"
    - ssh-keyscan $SERVER_IP >> ~/.ssh/known_hosts

  script:
    - echo "ðŸš€ Starting deployment to $SERVER_IP"

    - echo "ðŸ”— Connecting to server and starting deployment steps"
    - |
      ssh -o StrictHostKeyChecking=no $SSH_USER@$SERVER_IP << EOF
        echo "ðŸ“‚ Moving to project directory: $PROJECT_DIR"
        cd $PROJECT_DIR || { echo 'âŒ Failed to move to project directory'; exit 1; }

        echo "ðŸ”„ Pulling latest changes from FE branch"
        git reset --hard
        git clean -fd
        git pull origin FE || { echo 'âŒ Git pull failed'; exit 1; }

        echo "ðŸ³ Building Docker image: $IMAGE_NAME"
        docker build -t $IMAGE_NAME . || { echo 'âŒ Docker build failed'; exit 1; }

        echo "ðŸ›‘ Stopping existing container: $CONTAINER_NAME"
        docker stop $CONTAINER_NAME || echo "âš ï¸ No container to stop"

        echo "ðŸ§¹ Removing old container: $CONTAINER_NAME"
        docker rm $CONTAINER_NAME || echo "âš ï¸ No container to remove"

        echo "ðŸš¢ Running new container"
        docker run -d \
          -p $PORT:$PORT \
          -e NEXT_PUBLIC_WEBSOCKET_URL=ws://13.124.231.140:8080/ws \
          -e NEXT_PUBLIC_BASE_URL=http://13.124.231.140:8080 \
          -e NEXT_PUBLIC_SSE_URL=http://13.124.231.140:8080/sse \
          --restart always \
          --name $CONTAINER_NAME $IMAGE_NAME || { echo 'âŒ Docker run failed'; exit 1; }

        echo "âœ… Deployment finished successfully"
      EOF
