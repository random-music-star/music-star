stages:
  - build
  - deploy

build:
  stage: build
  tags:
    - prod
  script:
    - cd FE
    - npm config set prefix ~/.npm-global
    - export PATH=~/.npm-global/bin:$PATH
    - npm install -g pnpm
    - pnpm install
    - echo "NEXT_PUBLIC_WEBSOCKET_URL=ws://13.124.231.140:8080/ws" > .env
    - echo "NEXT_PUBLIC_BASE_URL=http://13.124.231.140:8080" >> .env
    - echo "NEXT_PUBLIC_SSE_URL=http://13.124.231.140:8080/sse" >> .env
    - pnpm build
  only:
    - FE
  artifacts:
    paths:
      - FE/.next
      - FE/node_modules
      - FE/package.json
      - FE/.env

deploy:
  stage: deploy
  tags:
    - prod
  script:
    - cd /home/ubuntu/S12P21A202
    - git fetch
    - git checkout FE
    - git pull origin FE
    - cd FE
    - docker stop nextjs-app || true
    - docker rm nextjs-app || true
    - docker build -t nextjs-app .
    - docker run -d -p 3000:3000 -e NEXT_PUBLIC_WEBSOCKET_URL=ws://13.124.231.140:8080/ws -e NEXT_PUBLIC_BASE_URL=http://13.124.231.140:8080 -e NEXT_PUBLIC_SSE_URL=http://13.124.231.140:8080/sse --restart always --name nextjs-app nextjs-app
  only:
    - FE
